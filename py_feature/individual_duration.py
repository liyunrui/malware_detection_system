import pandas as pd
import numpy as np
import datetime # datetime preprocessing
import utils # made by author for efficiently dealing with data

##################################
# loading data
##################################
train = pd.read_csv('../input/train.csv.gz', compression='gzip', dtype={'ProductID': str})
test = pd.read_csv('../input/test.csv.gz', compression='gzip', dtype={'ProductID': str})

print('loading finish')

##################################
# pre-processing
##################################

# convert query_datetime(str type) column to datetime type
train['query_datetime'] = pd.to_datetime(train.query_datetime)
test['query_datetime'] = pd.to_datetime(test.query_datetime)


def psersonal_duration_estimation(x):
    '''
    duration in day
    
    std:代表的是數值的分散程度
    
    parameters:
    --------
    x: DataFrame
    '''
    x['std-psersonal_duration_time'] = x.psersonal_duration.std()
    x['mean-psersonal_duration_time'] = x.psersonal_duration.mean()
    x['min-psersonal_duration_time'] = x.psersonal_duration.min()
    x['max-psersonal_duration_time'] = x.psersonal_duration.max()
    #remove useful columns
    x.drop(['first_time','last_time','psersonal_duration'], axis = 1, inplace = True)
    return x

#-------------------------
# train
#-------------------------

df1 = train.groupby(by = ['id','CustomerID']).query_datetime.min().to_frame('first_time')
df2 = train.groupby(by = ['id','CustomerID']).query_datetime.max().to_frame('last_time')
train = pd.concat([df1,df2], axis =1)
del df1, df2
#計算每個消費者個別使用此程式的持續時間
train['psersonal_duration'] = (train['last_time'] - train['first_time']).map(lambda x: x.days)

train = train.groupby('id').apply(psersonal_duration_estimation).reset_index() \
.drop_duplicates('id')[['id','std-psersonal_duration_time','mean-psersonal_duration_time',
                       'min-psersonal_duration_time','max-psersonal_duration_time']]
#-------------------------
# test
#-------------------------

df1 = test.groupby(by = ['id','CustomerID']).query_datetime.min().to_frame('first_time')
df2 = test.groupby(by = ['id','CustomerID']).query_datetime.max().to_frame('last_time')
test = pd.concat([df1,df2], axis =1)
del df1, df2
#計算每個消費者個別使用此程式的持續時間
test['psersonal_duration'] = (test['last_time'] - test['first_time']).map(lambda x: x.days)

test = test.groupby('id').apply(psersonal_duration_estimation).reset_index() \
.drop_duplicates('id')[['id','std-psersonal_duration_time','mean-psersonal_duration_time',
                       'min-psersonal_duration_time','max-psersonal_duration_time']]


#-------------------------
#save
#-------------------------

train.to_csv('../feature/{}/individual_duration_stats.csv.gz'.format('train'), index = False, compression='gzip')
test.to_csv('../feature/{}/individual_duration_stats.csv.gz'.format('test'), index = False, compression='gzip')
