#!/usr/bin/python3
# -*-coding:utf-8
'''
Created on Fri March 1 22:22:35 2017

@author: Ray

'''
import pandas as pd
import numpy as np
import datetime # datetime preprocessing
import time
from datetime import datetime
import gc

import warnings
warnings.filterwarnings("ignore")

##################################
# loading data
##################################
s = time.time()
train = pd.read_csv('../input/train.csv.gz', compression='gzip', dtype={'ProductID': str})
test = pd.read_csv('../input/test.csv.gz', compression='gzip', dtype={'ProductID': str})

# ProductID Cleaning
train['ProductID'] = train.ProductID.map(str)
train['ProductID'] = train.ProductID.apply(lambda x: '055649' if x == '55649' else x)
test['ProductID'] = test.ProductID.map(str)
test['ProductID'] = test.ProductID.apply(lambda x: '055649' if x == '55649' else x)

# convert query_datetime(str type) column to datetime type
train['query_datetime'] = pd.to_datetime(train.query_datetime)
test['query_datetime'] = pd.to_datetime(test.query_datetime)

e = time.time()
print (e - s)

df_all = pd.concat([train,test])
df_all = df_all.drop('label', axis = 1)


# 此消費者使用多少個不同裝置？
df1 = df_all.groupby(by = ['CustomerID']).apply(lambda x: x.ProductID.nunique()).to_frame('num_device_user_used')
df1 = df1.reset_index()
# 此消費者使用多少個程式？
df2 = df_all.groupby(by = ['CustomerID']).apply(lambda x: x.id.nunique()).to_frame('num_computer_program_user_used')
df2 = df2.reset_index()
# merge
df = pd.merge(df1,df2, on = 'CustomerID', how = 'left')
del df1, df2
# output
df.to_csv('../input/customer_info1.csv.gz', index=False, compression='gzip')



