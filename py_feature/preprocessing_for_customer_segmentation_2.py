#!/usr/bin/python3
# -*-coding:utf-8
'''
Created on Fri March 1 22:22:35 2017

@author: Ray

'''
import pandas as pd
import numpy as np
import datetime # datetime preprocessing
import time
from datetime import datetime
import gc

import warnings
warnings.filterwarnings("ignore")

##################################
# loading data
##################################
s = time.time()
train = pd.read_csv('../input/train.csv.gz', compression='gzip', dtype={'ProductID': str})
test = pd.read_csv('../input/test.csv.gz', compression='gzip', dtype={'ProductID': str})

# ProductID Cleaning
train['ProductID'] = train.ProductID.map(str)
train['ProductID'] = train.ProductID.apply(lambda x: '055649' if x == '55649' else x)
test['ProductID'] = test.ProductID.map(str)
test['ProductID'] = test.ProductID.apply(lambda x: '055649' if x == '55649' else x)

# convert query_datetime(str type) column to datetime type
train['query_datetime'] = pd.to_datetime(train.query_datetime)
test['query_datetime'] = pd.to_datetime(test.query_datetime)

e = time.time()
print (e - s)

df_all = pd.concat([train,test])
df_all = df_all.drop('label', axis = 1)


#計算每個消費者花多少時間在程式上面
df1 = df_all.groupby(by = ['id','CustomerID']).query_datetime.min().to_frame('first_time')
df2 = df_all.groupby(by = ['id','CustomerID']).query_datetime.max().to_frame('last_time')
df = pd.concat([df1,df2], axis =1)
del df1, df2
df['psersonal_duration'] = (df['last_time'] - df['first_time']).map(lambda x: x.total_seconds())
df = df.reset_index()[['CustomerID','psersonal_duration']]
df = df.groupby('CustomerID').psersonal_duration.sum().to_frame('spent_time_on_programe_in_sec').reset_index()

# output
df.to_csv('../input/customer_info2.csv.gz', index=False, compression='gzip')



