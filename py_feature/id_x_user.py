import pandas as pd
import numpy as np
import datetime # datetime preprocessing
import utils # made by author for efficiently dealing with data
from math import ceil 

##################################
# loading data
##################################
train = pd.read_csv('../input/train.csv.gz', compression='gzip', dtype={'ProductID': str})
test = pd.read_csv('../input/test.csv.gz', compression='gzip', dtype={'ProductID': str})

customer_info = pd.merge(pd.read_csv('../input/customer_info1.csv.gz',compression='gzip'),
                        pd.read_csv('../input/customer_info2.csv.gz',compression='gzip'), on = 'CustomerID', how = 'left'
)
print('loading finish')


#-------------------------
# train
#-------------------------

train = pd.merge(train[['id','CustomerID']],customer_info, on = 'CustomerID', how = 'left')
# 使用此程式的消費者平均使用多少個不同裝置？
# 使用此程式的消費者平均使用多少個不同程式？
# 使用此程式的消費者平均花多少時間在他所用過的程式上？
train = train.drop_duplicates('CustomerID')
train = train.groupby('id').mean().add_prefix('mean-').reset_index()

print('train done')

#-------------------------
# test
#-------------------------
test = pd.merge(test[['id','CustomerID']],customer_info, on = 'CustomerID', how = 'left')
# 使用此程式的消費者平均使用多少個不同裝置？
# 使用此程式的消費者平均使用多少個不同程式？
# 使用此程式的消費者平均花多少時間在他所用過的程式上？
test = test.drop_duplicates('CustomerID')
test = test.groupby('id').mean().add_prefix('mean-').reset_index()

print('test done')

#-------------------------
#save
#-------------------------
train.to_csv('../feature/{}/id_x_user.csv.gz'.format('train'), index = False, compression='gzip')
test.to_csv('../feature/{}/id_x_user.csv.gz'.format('test'), index = False, compression='gzip')


