import pandas as pd
import numpy as np
import datetime # datetime preprocessing
import utils # made by author for efficiently dealing with data

##################################
# loading data
##################################
train = pd.read_csv('../input/train.csv.gz', compression='gzip', dtype={'ProductID': str})
test = pd.read_csv('../input/test.csv.gz', compression='gzip', dtype={'ProductID': str})

print('loading finish')

##################################
# pre-processing
##################################

# convert query_datetime(str type) column to datetime type
train['query_datetime'] = pd.to_datetime(train.query_datetime)
test['query_datetime'] = pd.to_datetime(test.query_datetime)

# ProductID Cleaning
train['ProductID'] = train.ProductID.map(str)
train['ProductID'] = train.ProductID.apply(lambda x: '055649' if x == '55649' else x)
test['ProductID'] = test.ProductID.map(str)
test['ProductID'] = test.ProductID.apply(lambda x: '055649' if x == '55649' else x)

print('pre-processing done')

#-------------------------
# train
#-------------------------
#這個程式涉及多少種類裝置
train = train.groupby(by = ['id','ProductID']).count() \
.reset_index('ProductID').groupby('id').count() \
.rename(columns = {'ProductID': 'count_product'})[['count_product']].reset_index()


#-------------------------
# test
#-------------------------

test = test.groupby(by = ['id','ProductID']).count() \
.reset_index('ProductID').groupby('id').count() \
.rename(columns = {'ProductID': 'count_product'})[['count_product']].reset_index()

#-------------------------
#save
#-------------------------

train.to_csv('../feature/{}/num_prodcut.csv.gz'.format('train'), index = False, compression='gzip')
test.to_csv('../feature/{}/num_prodcut.csv.gz'.format('test'), index = False, compression='gzip')
